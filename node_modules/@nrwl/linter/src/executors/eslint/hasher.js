"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const fileutils_1 = require("@nrwl/workspace/src/utilities/fileutils");
const app_root_1 = require("@nrwl/tao/src/utils/app-root");
const path_1 = require("path");
function run(task, taskGraph, hasher) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        if (task.overrides['hasTypeAwareRules'] === true) {
            return hasher.hashTaskWithDepsAndContext(task);
        }
        const command = hasher.hashCommand(task);
        const sources = yield hasher.hashSource(task);
        const deps = allDeps(task.id, taskGraph);
        const nxJson = fileutils_1.readJsonFile(path_1.join(app_root_1.appRootPath, 'nx.json'));
        const tags = hasher.hashArray(deps.map((d) => (nxJson.projects[d].tags || []).join('|')));
        const context = yield hasher.hashContext();
        return {
            value: hasher.hashArray([
                command,
                sources,
                tags,
                context.implicitDeps.value,
                context.runtime.value,
            ]),
            details: {
                command,
                nodes: { [task.target.project]: sources, tags },
                implicitDeps: context.implicitDeps.files,
                runtime: context.runtime.runtime,
            },
        };
    });
}
exports.default = run;
function allDeps(taskId, taskGraph) {
    return [
        ...taskGraph.dependencies[taskId].map((task) => taskGraph.tasks[task].target.project),
        ...taskGraph.dependencies[taskId].flatMap((task) => allDeps(task, taskGraph)),
    ];
}
//# sourceMappingURL=hasher.js.map